<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ward Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        medical: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
                        slate: { 850: '#1e293b' }
                    },
                    boxShadow: { 'card': '0 2px 8px rgba(0,0,0,0.04)', 'float': '0 10px 30px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        .bed-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: var(--theme-shadow-card); transition: all 0.2s; min-height: 160px; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .bed-card:hover { border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .bed-card.selected { border: 2px solid #0ea5e9; background-color: #f0f9ff; }
        .bed-card.vacant { background: #f1f5f9; border: 1px solid #cbd5e1; border-style: dashed; justify-content: center; align-items: center; opacity: 0.8; min-height: 100px; }
        .bed-card.vacant:hover { opacity: 1; border-color: #94a3b8; background: #e2e8f0; cursor: pointer; }
        .fs-mode { position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 9999 !important; width: 100vw !important; height: 100vh !important; background-color: #e2e8f0 !important; display: flex; justify-content: center; align-items: center; }
        .fs-paper { width: 60%; height: 90%; background: white; box-shadow: 0 10px 50px rgba(0,0,0,0.3); padding: 60px; font-size: 16pt; line-height: 1.6; outline: none; resize: none; overflow-y: auto; color: #1e293b; border-radius: 4px; }
        .consult-chip { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; border: 1px solid transparent; transition: all 0.2s; }
        .consult-chip.active { background-color: #e0f2fe; color: #0284c7; border-color: #bae6fd; }
        .consult-chip.inactive { background-color: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; opacity: 0.7; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .color-dot.selected { border-color: #334155; transform: scale(1.1); box-shadow: 0 0 0 2px #cbd5e1; }
        .matrix-col { min-width: 250px; background: #f8fafc; border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; }
        .grid-1 { grid-template-columns: repeat(1, 1fr); } .grid-2 { grid-template-columns: repeat(2, 1fr); } .grid-3 { grid-template-columns: repeat(3, 1fr); } .grid-4 { grid-template-columns: repeat(4, 1fr); } .grid-5 { grid-template-columns: repeat(5, 1fr); } .grid-6 { grid-template-columns: repeat(6, 1fr); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; } .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }
        
        /* FIX: Black Cursor for Light App Background (High Contrast) */
        input, textarea, [contenteditable="true"] {
            caret-color: black !important;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32' stroke='black' stroke-width='3' stroke-linecap='round'><path d='M16 4v24M11 4h10M11 28h10'/></svg>") 16 16, text !important;
        }

        @keyframes spin-forced { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin-active { animation: spin-forced 1s linear infinite; }

        @media print {
            body * { visibility: hidden; }
            #printContainer, #printContainer * { visibility: visible; }
            #printContainer { position: absolute; left: 0; top: 0; width: 100%; display: block !important; background: white; }
            #appContainer { display: none !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <div id="saveToast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-[10001] px-6 py-3 rounded-full text-white font-bold shadow-2xl transition-all duration-300 opacity-0 translate-y-10 flex items-center gap-3 bg-slate-900 pointer-events-none">
        <i class="fa-solid fa-floppy-disk"></i> <span id="saveToastMsg">Saving...</span>
    </div>
    
    <div id="printContainer" class="hidden bg-white p-10"></div>

    <!-- AUTH OVERLAY -->
    <div id="authOverlay" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center bg-white p-8 rounded-2xl shadow-float border border-slate-100">
            <div class="w-16 h-16 bg-medical-600 rounded-2xl mx-auto mb-4 flex items-center justify-center text-white text-3xl shadow-lg shadow-medical-500/30">
                <i class="fa-solid fa-hospital-user"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800" id="authTitle">Ward Manager</h1>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-6" id="authSub">Accessing: <span id="loginDbName" class="text-medical-600">...</span></p>
            <div id="authForm" class="hidden space-y-3">
                <input type="password" id="loginPin" placeholder="Enter Password" class="w-full p-3 text-center text-lg font-bold rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-medical-500 focus:bg-white transition">
                <button onclick="verifyPassword()" id="btnLogin" class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition">Login</button>
            </div>
            <div id="setupForm" class="hidden space-y-3">
                <div class="bg-orange-50 text-orange-600 p-3 rounded-xl text-xs font-bold mb-2 border border-orange-100"><i class="fa-solid fa-triangle-exclamation mr-1"></i> New Database Detected</div>
                <input type="password" id="setupPin" placeholder="Create Password" class="w-full p-3 text-center text-lg font-bold rounded-xl border border-slate-200 bg-white">
                <button onclick="setupPassword()" class="w-full py-3 bg-medical-600 text-white font-bold rounded-xl shadow-lg">Set Password</button>
            </div>
            <div id="loadingState" class="mt-4"><i class="fa-solid fa-circle-notch spin-active text-medical-500 text-2xl"></i></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="hidden flex-1 flex flex-col h-full bg-[#f8fafc]">
        <header class="glass-header h-16 flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center gap-3">
                <button onclick="toggleGridMenu()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 text-slate-600 flex items-center justify-center shadow-sm hover:bg-slate-50 hover:text-medical-600 transition" title="Grid Settings"><i class="fa-solid fa-table-cells"></i></button>
                <div class="leading-tight">
                    <h2 class="font-bold text-lg text-slate-800" id="headerWard">General Ward</h2>
                    <span id="roleBadge" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Resident View</span>
                </div>
                
                <!-- NEW: CHIEF SOURCE SELECTOR -->
                <div id="chiefSourceSelector" class="hidden ml-2">
                    <div class="flex items-center gap-2 bg-orange-50 border border-orange-200 rounded-lg px-2 py-1">
                        <i class="fa-solid fa-database text-orange-500 text-xs"></i>
                        <select id="dbSelector" onchange="switchDatabase(this.value)" class="bg-transparent text-xs font-bold text-orange-700 outline-none cursor-pointer min-w-[120px]">
                            <option value="">Select Source...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <div class="bg-slate-100 p-1 rounded-lg flex text-xs font-bold text-slate-500 mr-2 border border-slate-200">
                     <button onclick="switchView('grid')" id="viewBtnGrid" class="px-3 py-1.5 rounded-md bg-white shadow-sm text-medical-700 transition">Grid</button>
                     <button onclick="switchView('matrix')" id="viewBtnMatrix" class="px-3 py-1.5 rounded-md hover:bg-white/50 transition">Consults</button>
                     <button onclick="switchView('handoff')" id="viewBtnHandoff" class="px-3 py-1.5 rounded-md hover:bg-white/50 transition">Sign-Out</button>
                     <button onclick="switchView('discharged')" id="viewBtnDischarged" class="px-3 py-1.5 rounded-md hover:bg-white/50 text-slate-400 hover:text-rose-500 transition">Discharged</button>
                 </div>
                 <button onclick="changeWard()" class="bg-white border border-slate-200 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2 hover:bg-slate-50"><i class="fa-solid fa-right-left"></i> <span class="hidden sm:inline">Change Ward</span></button>
                 <button onclick="toggleSelectMode()" id="btnSelectMode" class="w-10 h-10 rounded-lg bg-white border border-slate-200 text-slate-500 flex items-center justify-center hover:text-medical-600 shadow-sm" title="Select Multiple"><i class="fa-regular fa-square-check"></i></button>
                 <button onclick="openSettings()" class="w-10 h-10 rounded-lg bg-white border border-slate-200 text-slate-500 flex items-center justify-center hover:text-medical-600 shadow-sm"><i class="fa-solid fa-gear"></i></button>
                 <button onclick="manualRefresh()" id="btnRefresh" class="w-10 h-10 rounded-lg bg-slate-800 text-white flex items-center justify-center shadow-md hover:bg-slate-700"><i class="fa-solid fa-rotate"></i></button>
            </div>
        </header>

        <div id="selectionToolbar" class="hidden bg-slate-800 text-white px-4 py-2 flex justify-between items-center shadow-lg z-30">
            <span class="text-xs font-bold"><span id="selectCount">0</span> selected</span>
            <div class="flex gap-2">
                <button onclick="exportBatch()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs font-bold">Export .txt</button>
                <button onclick="deleteBatch()" class="bg-rose-600 hover:bg-rose-500 px-3 py-1 rounded text-xs font-bold">Delete</button>
                <button onclick="toggleSelectMode()" class="bg-slate-700 px-3 py-1 rounded text-xs">Cancel</button>
            </div>
        </div>

        <div id="gridMenu" class="hidden absolute top-16 left-4 z-40 bg-white rounded-xl shadow-xl border border-slate-100 p-4 w-64 animate-fade-in">
            <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3">Grid Layout (Columns)</h4>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <button onclick="setGrid(1)" class="p-2 border rounded hover:bg-slate-50 text-xs font-bold">1 Col</button>
                <button onclick="setGrid(2)" class="p-2 border rounded hover:bg-slate-50 text-xs font-bold">2 Cols</button>
                <button onclick="setGrid(3)" class="p-2 border rounded hover:bg-slate-50 text-xs font-bold">3 Cols</button>
                <button onclick="setGrid(4)" class="p-2 border rounded hover:bg-slate-50 text-xs font-bold">4 Cols</button>
                <button onclick="setGrid(5)" class="p-2 border rounded hover:bg-slate-50 text-xs font-bold">5 Cols</button>
                <button onclick="setGrid(6)" class="p-2 border rounded hover:bg-slate-50 text-xs font-bold">6 Cols</button>
            </div>
            <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Total Beds</h4>
            <div class="flex items-center gap-2"><input type="range" min="10" max="100" step="1" id="bedCountSlider" oninput="updateBedCount(this.value)" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-medical-600"><span id="bedCountLabel" class="text-xs font-bold w-8 text-center">36</span></div>
        </div>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 relative" id="mainScroll">
            <!-- EMPTY STATE FOR CHIEF -->
            <div id="chiefEmptyState" class="hidden h-full flex flex-col items-center justify-center text-slate-400 pb-20">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4"><i class="fa-solid fa-arrow-up text-2xl text-slate-300"></i></div>
                <p class="font-bold">Select a Ward Source above</p>
                <p class="text-xs mt-1">To view patient data, select a resident database.</p>
            </div>

            <div id="viewGrid" class="block"><div id="bedGrid" class="grid gap-3 pb-20 transition-all duration-300"></div></div>
            <div id="viewMatrix" class="hidden pb-20"><div id="matrixContainer" class="flex gap-4 overflow-x-auto pb-6 snap-x"></div></div>
            
            <div id="viewHandoff" class="hidden pb-20 max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-slate-800">Sign-Out / Handoff Sheet</h3>
                    <button onclick="printHandoff()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-700"><i class="fa-solid fa-print mr-2"></i> Print / PDF</button>
                </div>
                <div id="handoffContent" class="bg-white p-8 shadow-sm border border-slate-200 rounded-xl font-mono text-xs"></div>
            </div>
            
            <div id="viewDischarged" class="hidden pb-20"><h3 class="text-lg font-bold text-slate-600 mb-4 flex items-center gap-2"><i class="fa-solid fa-box-archive"></i> Archived Patients</h3><div id="dischargedList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div></div>
        </main>
        <button onclick="openEditor(null)" class="fixed bottom-6 right-6 w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center z-30 hover:scale-105 transition hover:bg-medical-600"><i class="fa-solid fa-plus text-xl"></i></button>
    </div>

    <div id="editorModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeEditor()"></div>
        <div class="absolute inset-x-0 bottom-0 top-12 md:top-10 md:inset-x-auto md:right-0 md:w-[90vw] md:max-w-7xl bg-white rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none flex flex-col shadow-2xl animate-slide-up">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white z-10 shrink-0">
                <div class="flex items-center gap-3"><div id="editorBedBadge" class="bg-slate-800 text-white text-xl font-bold px-3 py-1 rounded-lg">#01</div><div><h3 class="text-lg font-bold text-slate-800 leading-none" id="editorTitle">New Patient</h3><p class="text-[10px] font-bold text-slate-400 uppercase mt-0.5">Admit Details</p></div></div>
                <div class="flex gap-2"><button onclick="toggleDischarge()" id="btnDischarge" class="px-4 py-2 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold transition hover:bg-slate-200">Archive</button><button onclick="closeEditor()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark text-lg"></i></button></div>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col md:flex-row bg-white">
                <div class="hidden md:flex md:w-[65%] flex-col bg-slate-50/50 border-r border-slate-200 relative">
                    <div class="flex justify-between items-center p-3 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span> Clinical Notes</label>
                        <button onclick="toggleFullScreen()" class="text-medical-600 text-xs font-bold flex items-center gap-1 hover:text-medical-700 bg-medical-50 px-3 py-1.5 rounded-lg transition hover:bg-medical-100"><i class="fa-solid fa-expand"></i> Fullscreen</button>
                    </div>
                    <textarea id="editDetailsDesktop" ondblclick="toggleFullScreen()" oninput="syncDetails(this)" class="flex-1 w-full bg-transparent p-6 text-slate-700 leading-relaxed outline-none resize-none font-sans text-lg focus:bg-white transition" placeholder="• Chief Complaint&#10;• Active Issues&#10;• Plan..."></textarea>
                </div>
                <div class="flex-1 overflow-y-auto p-5 space-y-5 bg-white custom-scrollbar md:w-[35%]">
                    <div id="residentSelectorDiv" class="hidden flex flex-col space-y-1 mb-2 p-3 bg-orange-50 border border-orange-200 rounded-xl"><label class="text-[10px] font-bold text-orange-600 uppercase flex items-center gap-1"><i class="fa-solid fa-crown"></i> Assign to Resident</label><select id="residentSelect" class="w-full bg-white border border-orange-300 rounded-lg p-2 font-bold text-sm outline-none focus:ring-2 focus:ring-orange-200"></select></div>
                    <div class="flex gap-4 p-4 bg-slate-50/80 rounded-2xl border border-slate-100"><div class="w-24 space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Bed No.</label><select id="editBed" onchange="changeBedInEditor()" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 font-bold text-center text-lg outline-none focus:border-medical-500 shadow-sm"></select></div><div class="flex-1 space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Name (Auto-fill)</label><input type="text" id="editName" class="w-full bg-white border border-slate-200 rounded-lg p-2.5 font-bold text-lg outline-none focus:border-medical-500 placeholder:font-normal placeholder:text-slate-300 shadow-sm" placeholder="e.g. Somchai"></div></div>
                    <div class="space-y-1 px-1"><label class="text-[10px] font-bold text-slate-400 uppercase">HN (Optional)</label><input type="text" id="editHN" class="w-full bg-transparent border-b border-slate-200 p-2 font-mono text-sm outline-none focus:border-medical-500 transition" placeholder="HN 1234567"></div>
                    <div class="md:hidden space-y-2"><label class="text-[10px] font-bold text-slate-400 uppercase px-1 flex justify-between"><span>Medical Details</span><span class="text-medical-500" onclick="toggleFullScreen()">Expand</span></label><textarea id="editDetailsMobile" oninput="syncDetails(this)" class="w-full bg-yellow-50/30 border border-yellow-200/50 rounded-xl p-4 text-slate-700 leading-relaxed outline-none min-h-[150px]" placeholder="Clinical notes..."></textarea></div>
                    <div class="space-y-2"><label class="text-[10px] font-bold text-slate-400 uppercase px-1">Status Tag</label><div id="colorContainer" class="flex flex-wrap gap-2 px-1"></div></div>
                    <div class="space-y-2"><label class="text-[10px] font-bold text-slate-400 uppercase px-1">Consults</label><div id="consultContainer" class="flex flex-wrap gap-2 px-1 mb-2"></div><div class="flex gap-2 px-1 items-center"><input type="text" id="customConsult" placeholder="Add Other..." class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none focus:border-medical-500 flex-1"><button onclick="addCustomConsult()" class="bg-slate-800 text-white w-8 h-8 rounded-lg text-xs font-bold"><i class="fa-solid fa-plus"></i></button></div></div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-xs text-slate-500 uppercase"><i class="fa-solid fa-list-check mr-1"></i> To-Do List</h4><button onclick="addTodo()" class="w-6 h-6 rounded bg-white border border-slate-200 text-medical-600 flex items-center justify-center hover:shadow-sm"><i class="fa-solid fa-plus text-xs"></i></button></div>
                        <div id="todoContainer" class="space-y-2"></div>
                        <datalist id="taskSuggestions">
                            <option value="Follow Lab">
                            <option value="Film Chest">
                            <option value="D/C Summary">
                            <option value="Family Meeting">
                            <option value="Consult Cardio">
                            <option value="Review Meds">
                            <option value="Sputum Exam">
                            <option value="Keep NPO">
                            <option value="Off Foley">
                        </datalist>
                    </div>
                    <div class="pt-4"><button onclick="deleteRecord()" id="btnDelete" class="w-full text-rose-400 text-xs font-bold py-3 hover:text-rose-600 transition flex items-center justify-center gap-2"><i class="fa-regular fa-trash-can"></i> Delete Permanently</button></div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-slate-100 pb-8 shrink-0"><button onclick="saveRecord()" id="btnSave" class="w-full bg-slate-800 text-white text-lg font-bold py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2 hover:bg-slate-700"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button></div>
        </div>
    </div>

    <div id="fullscreenOverlay" class="hidden fs-mode">
        <textarea id="fullscreenEditor" ondblclick="toggleFullScreen()" class="fs-paper" placeholder="Medical Details..."></textarea>
        <div class="absolute top-6 right-6 flex gap-3">
             <button onclick="toggleFullScreen()" class="bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-lg hover:bg-slate-900 transition flex items-center gap-2 transform active:scale-95"><i class="fa-solid fa-compress"></i> Exit Fullscreen</button>
        </div>
        <div class="absolute bottom-6 right-6">
             <button onclick="saveRecord()" class="bg-emerald-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-lg hover:bg-emerald-700 transition flex items-center gap-2 transform active:scale-95"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
        </div>
    </div>

    <div id="wardModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-80 p-6 shadow-2xl animate-fade-in">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Select Ward</h3>
            <div id="wardList" class="space-y-2 max-h-60 overflow-y-auto mb-4 pr-2"></div>
            <div class="flex gap-2 border-t pt-4"><input type="text" id="newWardName" placeholder="New Ward..." class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm flex-1 outline-none focus:border-medical-500"><button onclick="createNewWard()" class="bg-medical-600 text-white w-10 rounded-lg font-bold hover:bg-medical-700"><i class="fa-solid fa-plus"></i></button></div>
            <button onclick="document.getElementById('wardModal').classList.add('hidden')" class="mt-4 w-full text-slate-400 text-sm font-bold hover:text-slate-600">Cancel</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxZrOuiFqLzmaX9T7PN7xqwV-jvE80dBuNk4Gc3nV1K8-ZZw0YUEYDupPg_RKc1JUFB/exec";
        const STANDARD_UNITS = [{id: 'Cardio', icon: 'fa-heart-pulse'}, {id: 'Chest', icon: 'fa-lungs'}, {id: 'GI', icon: 'fa-burger'},{id: 'Neuro', icon: 'fa-brain'}, {id: 'Nephro', icon: 'fa-kidney'}, {id: 'ID', icon: 'fa-virus'}, {id: 'Hemato', icon: 'fa-droplet'}, {id: 'Onco', icon: 'fa-radiation'}, {id: 'Endo', icon: 'fa-cube'},{id: 'Rheumato', icon: 'fa-bone'}, {id: 'Skin', icon: 'fa-hand-dots'}];
        const COLORS = ['#ffffff', '#fecaca', '#fca5a5', '#f87171', '#fed7aa', '#fdba74', '#fb923c', '#fef08a', '#fde047', '#facc15', '#bbf7d0', '#86efac', '#4ade80', '#99f6e4', '#5eead4', '#2dd4bf', '#bfdbfe', '#93c5fd', '#60a5fa', '#ddd6fe', '#c4b5fd', '#a78bfa', '#fbcfe8', '#f9a8d4', '#f472b6', '#e2e8f0', '#cbd5e1', '#94a3b8'];
        const TAG_COLORS = ['bg-red-600', 'bg-blue-600', 'bg-amber-500', 'bg-teal-600', 'bg-purple-600', 'bg-emerald-600', 'bg-rose-500', 'bg-cyan-600', 'bg-indigo-600', 'bg-lime-600', 'bg-fuchsia-600', 'bg-sky-600', 'bg-orange-600', 'bg-slate-600'];

        let DB_NAME = new URLSearchParams(window.location.search).get('db');
        let ROLE = new URLSearchParams(window.location.search).get('role') || 'resident';
        let PASSWORD = "";
        let records = []; let availableResidents = [];
        let currentWard = "General Ward";
        let wards = new Set(["General Ward"]);
        let gridCols = 3; let totalBeds = 36;
        let editingId = null; let originalOwner = null;
        let activeConsults = []; let currentTodos = []; let currentDischarged = false;
        let isSelectMode = false; let selectedIds = new Set();
        let autoSaveTimer = null; let refreshTimer = null;
        let toastTimer = null; 
        
        // NEW: Chief State
        let chiefSelectedDB = ""; 

        window.onload = () => {
            if(!DB_NAME) return document.body.innerHTML = "<div class='p-10 text-center font-bold'>Error: No Database Selected</div>";
            document.getElementById('loginDbName').innerText = DB_NAME;
            document.getElementById('roleBadge').innerText = ROLE === 'chief' ? "Ward Chief" : "Ward Resident";
            if(ROLE === 'chief') {
                document.getElementById('roleBadge').className = "text-[10px] font-bold text-orange-500 uppercase tracking-wider";
                document.getElementById('viewBtnHandoff').style.display = 'none'; // Hide Handoff for Chief
                document.getElementById('chiefSourceSelector').classList.remove('hidden'); // Show Dropdown
            }
            const savedGrid = localStorage.getItem('ward_grid_cols'); if(savedGrid) gridCols = parseInt(savedGrid);
            const savedBeds = localStorage.getItem('ward_total_beds'); if(savedBeds) { totalBeds = parseInt(savedBeds); document.getElementById('bedCountSlider').value = totalBeds; document.getElementById('bedCountLabel').innerText = totalBeds; }
            checkAuth(); renderColorPicker();
        };

        function getOwnerColor(name) {
            if (!name) return 'bg-slate-500';
            let hash = 0; for (let i = 0; i < name.length; i++) { hash = Math.imul(31, hash) + name.charCodeAt(i) | 0; }
            hash = Math.imul(hash ^ (hash >>> 15), 0x85ebca6b); hash = Math.imul(hash ^ (hash >>> 13), 0xc2b2ae35); hash = hash ^ (hash >>> 16);
            return TAG_COLORS[Math.abs(hash) % TAG_COLORS.length];
        }

        async function checkAuth() { try { const res = await fetch(`${API_URL}?action=auth_check_status&db=${DB_NAME}`); const json = await res.json(); document.getElementById('loadingState').classList.add('hidden'); if (json.status === 'setup_needed') document.getElementById('setupForm').classList.remove('hidden'); else document.getElementById('authForm').classList.remove('hidden'); } catch(e) { alert("Connection Error"); } }
        async function verifyPassword() {
            const p = document.getElementById('loginPin').value; const btn = document.getElementById('btnLogin'); btn.innerText = "...";
            try {
                const res = await fetch(API_URL, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify({action: 'auth_verify', db: DB_NAME, password: p}) });
                const json = await res.json();
                if (json.status === 'success') {
                    PASSWORD = p;
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    await fetchData();
                    if (ROLE !== 'chief') changeWard(); 
                    startAutomation();
                } else { alert("Incorrect Password"); }
            } catch(e) { alert("Login Error: " + e.message); } finally { btn.innerText = "Login"; }
        }
        async function setupPassword() { const p = document.getElementById('setupPin').value; if(!p) return; await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'auth_set_password', db: DB_NAME, password: p}) }); location.reload(); }

        function startAutomation() {
            if (refreshTimer) clearInterval(refreshTimer);
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            refreshTimer = setInterval(() => { const editorClosed = document.getElementById('editorModal').classList.contains('hidden'); if(editorClosed && !isSelectMode) fetchData(true); }, 5000);
            autoSaveTimer = setInterval(() => { if(!document.getElementById('editorModal').classList.contains('hidden')) saveRecord(true); }, 30000);
        }

        // NEW: Specific DB Switching for Chiefs
        function switchDatabase(db) {
            chiefSelectedDB = db;
            records = []; // Clear current view
            renderView(); // Clear grid
            if(db) {
                document.getElementById('chiefEmptyState').classList.add('hidden');
                fetchData(); 
            } else {
                document.getElementById('chiefEmptyState').classList.remove('hidden');
            }
        }

        async function fetchData(silent = false) {
            if(!silent) document.getElementById('btnRefresh').classList.add('animate-spin', 'spin-active');
            
            try {
                // --- TARGETED FETCH FOR CHIEF ---
                if (ROLE === 'chief') {
                    // 1. Load User List (only once ideally, but cheap enough to reload)
                    const listRes = await fetch(`${API_URL}?action=admin_list_users`);
                    const listJson = await listRes.json();
                    
                    // Update Dropdown
                    const sel = document.getElementById('dbSelector');
                    const currentSel = sel.value;
                    availableResidents = listJson.users.filter(u => u.role === 'resident').map(u => u.name);
                    
                    sel.innerHTML = `<option value="">Select Source...</option>` + 
                        availableResidents.map(r => `<option value="${r}" ${r===chiefSelectedDB?'selected':''}>${r}</option>`).join('');
                    
                    if (chiefSelectedDB) {
                        sel.value = chiefSelectedDB; // Preserve selection
                        // 2. Fetch DATA only for selected DB
                        const res = await fetch(API_URL, { 
                            method: 'POST', 
                            headers: {"Content-Type": "text/plain;charset=utf-8"}, 
                            body: JSON.stringify({ action: 'read', db: chiefSelectedDB, password: PASSWORD, requester: DB_NAME }) 
                        });
                        const json = await res.json();
                        records = Array.isArray(json) ? json.map(rec => ({...processRecord(rec), owner: chiefSelectedDB})) : [];
                        document.getElementById('chiefEmptyState').classList.add('hidden');
                    } else {
                        // No DB selected yet
                        records = [];
                        document.getElementById('chiefEmptyState').classList.remove('hidden');
                    }
                } 
                // --- NORMAL FETCH FOR RESIDENT ---
                else {
                    const res = await fetch(API_URL, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify({action: 'read', db: DB_NAME, password: PASSWORD}) });
                    const json = await res.json();
                    if(json.error) throw new Error(json.error);
                    records = Array.isArray(json) ? json.map(processRecord) : [];
                }
            } catch(e) { if(!silent) console.error("Fetch Error:", e); }
            
            wards = new Set(["General Ward"]); records.forEach(r => { if(r.ward) wards.add(r.ward); });
            renderView();
            if(!silent) document.getElementById('btnRefresh').classList.remove('animate-spin', 'spin-active');
        }

        function processRecord(r) {
            let c = [], t = [];
            try { c = JSON.parse(r.consult_units); } catch(e) {}
            try { t = JSON.parse(r.todo_list); } catch(e) {}
            return { ...r, consult_units: Array.isArray(c) ? c : [], todo_list: Array.isArray(t) ? t : [], is_discharged: r.is_discharged === true || r.is_discharged === "TRUE" };
        }

        function switchView(view) {
            document.getElementById('viewGrid').classList.toggle('hidden', view !== 'grid');
            document.getElementById('viewMatrix').classList.toggle('hidden', view !== 'matrix');
            document.getElementById('viewHandoff').classList.toggle('hidden', view !== 'handoff');
            document.getElementById('viewDischarged').classList.toggle('hidden', view !== 'discharged');
            
            document.getElementById('viewBtnGrid').className = view === 'grid' ? "px-3 py-1.5 rounded-md bg-white shadow-sm text-medical-700 transition" : "px-3 py-1.5 rounded-md hover:bg-white/50 transition";
            document.getElementById('viewBtnMatrix').className = view === 'matrix' ? "px-3 py-1.5 rounded-md bg-white shadow-sm text-medical-700 transition" : "px-3 py-1.5 rounded-md hover:bg-white/50 transition";
            document.getElementById('viewBtnHandoff').className = view === 'handoff' ? "px-3 py-1.5 rounded-md bg-white shadow-sm text-slate-800 transition" : "px-3 py-1.5 rounded-md hover:bg-white/50 text-slate-500 transition";
            document.getElementById('viewBtnDischarged').className = view === 'discharged' ? "px-3 py-1.5 rounded-md bg-white shadow-sm text-rose-500 transition" : "px-3 py-1.5 rounded-md hover:bg-white/50 text-slate-400 hover:text-rose-500 transition";
            
            renderView();
        }
        function renderView() { 
            // Safety: If Chief has not selected a DB, don't render grid to avoid confusion
            if(ROLE === 'chief' && !chiefSelectedDB) {
                document.getElementById('bedGrid').innerHTML = "";
                document.getElementById('matrixContainer').innerHTML = "";
                return;
            }

            if(!document.getElementById('viewGrid').classList.contains('hidden')) renderGrid();
            else if(!document.getElementById('viewMatrix').classList.contains('hidden')) renderMatrix();
            else if(!document.getElementById('viewHandoff').classList.contains('hidden')) renderHandoff();
            else if(!document.getElementById('viewDischarged').classList.contains('hidden')) renderDischarged();
        }

        function toggleGridMenu() { document.getElementById('gridMenu').classList.toggle('hidden'); }
        function setGrid(cols) { gridCols = cols; localStorage.setItem('ward_grid_cols', cols); renderGrid(); toggleGridMenu(); }
        function updateBedCount(val) { totalBeds = parseInt(val); document.getElementById('bedCountLabel').innerText = val; localStorage.setItem('ward_total_beds', val); renderGrid(); }

        function renderGrid() {
            const grid = document.getElementById('bedGrid');
            grid.className = `grid gap-3 pb-20 grid-${gridCols}`; grid.innerHTML = "";
            document.getElementById('headerWard').innerText = currentWard;
            const activeRecords = records.filter(r => r.ward === currentWard && !r.is_discharged);
            
            for(let i=1; i<=totalBeds; i++) {
                const occupants = activeRecords.filter(r => parseInt(r.bed_number) === i);
                if (occupants.length === 0) {
                    grid.innerHTML += `<div onclick="handleVacantClick(${i})" class="bed-card vacant group"><span class="text-3xl font-bold text-slate-300 group-hover:text-medical-400">${i}</span><span class="text-[10px] font-bold text-slate-300 uppercase mt-1 group-hover:text-medical-500">Vacant</span></div>`;
                } else {
                    occupants.forEach(r => {
                        const isSelected = selectedIds.has(r.id);
                        const bg = r.color_id || '#ffffff';
                        const consultChips = r.consult_units.slice(0, 3).map(c => `<i class="fa-solid ${c.icon||'fa-circle'} text-[10px] text-slate-500"></i>`).join(' ');
                        const pendingTodos = r.todo_list.filter(t => !t.done);
                        let todoHtml = "";
                        if (pendingTodos.length > 0) {
                            todoHtml = `<div class="mt-auto pt-2 border-t border-slate-100/50 flex gap-1 overflow-hidden">`;
                            pendingTodos.slice(0, 3).forEach(t => { todoHtml += `<div class="text-[9px] px-1.5 py-0.5 bg-white border border-rose-200 text-rose-600 rounded shadow-sm font-bold truncate max-w-[80px]">${t.text}</div>`; });
                            if (pendingTodos.length > 3) todoHtml += `<div class="text-[9px] px-1.5 py-0.5 bg-slate-100 text-slate-500 border border-slate-200 rounded font-bold">+${pendingTodos.length - 3}</div>`;
                            todoHtml += `</div>`;
                        }
                        const tagColor = getOwnerColor(r.owner);
                        const ownerTag = (ROLE === 'chief' && r.owner) ? `<div class="absolute bottom-0 right-0 ${tagColor} text-white text-[9px] px-2 py-0.5 rounded-tl-lg z-10 font-bold opacity-90 shadow-sm">${(r.owner||'').substr(0,6)}</div>` : '';
                        
                        grid.innerHTML += `<div onclick="handleItemClick('${r.id}', ${i})" class="bed-card cursor-pointer group ${isSelected?'selected':''}" style="background: linear-gradient(to bottom, ${bg} 0%, #ffffff 60%)">${ownerTag}${isSelected?'<div class="absolute top-2 right-2 text-medical-600"><i class="fa-solid fa-circle-check text-lg"></i></div>':''}<div class="p-3 flex-1 flex flex-col relative"><div class="flex justify-between items-start mb-1"><span class="text-2xl font-bold text-slate-800">${i}</span><div class="flex gap-1 pt-1">${consultChips}</div></div><div class="mt-1 mb-2"><h4 class="font-bold text-sm text-slate-700 leading-tight truncate">${r.name||'Unknown'}</h4><p class="text-[10px] font-mono text-slate-400 mt-0.5">HN: ${r.hn||'-'}</p></div>${todoHtml}</div></div>`;
                    });
                }
            }
        }
        function handleVacantClick(i) { if(isSelectMode) return; openEditor(null, i); }

        function renderMatrix() { 
            const container = document.getElementById('matrixContainer'); 
            container.innerHTML = ""; 
            const activeRecords = records.filter(r => r.ward === currentWard && !r.is_discharged); 
            const usedUnits = new Set(); 
            activeRecords.forEach(r => r.consult_units.forEach(u => usedUnits.add(u.id))); 
            const sortedUnits = Array.from(usedUnits).sort(); 
            
            if(sortedUnits.length === 0) { container.innerHTML = "<div class='p-10 text-slate-400 italic'>No active consultations.</div>"; return; } 
            
            sortedUnits.forEach(unit => { 
                const patients = activeRecords.filter(r => r.consult_units.some(u => u.id === unit)); 
                let html = `<div class="matrix-col snap-center shrink-0"><h4 class="font-bold text-sm text-slate-700 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-user-md text-medical-500"></i> ${unit} <span class="bg-slate-200 text-slate-600 px-1.5 rounded-md text-[10px]">${patients.length}</span></h4><div class="space-y-2">`; 
                patients.forEach(r => { 
                    const isSelected = selectedIds.has(r.id);
                    const selClass = isSelected ? 'ring-2 ring-medical-500 border-medical-500 bg-medical-50' : 'border-slate-200 hover:border-medical-400';
                    const tagColor = getOwnerColor(r.owner);
                    const ownerTag = (ROLE === 'chief' && r.owner) ? `<div class="absolute bottom-0 right-0 ${tagColor} text-white text-[8px] px-1.5 py-0.5 rounded-tl-lg rounded-br-lg shadow-sm z-10">${(r.owner||'').substr(0,4)}</div>` : '';
                    html += `<div onclick="handleItemClick('${r.id}', ${r.bed_number})" class="relative overflow-hidden bg-white p-3 rounded-lg border shadow-sm cursor-pointer transition ${selClass}">${ownerTag}<div class="flex justify-between items-start"><span class="font-bold text-sm text-slate-800">Bed ${r.bed_number}</span></div><div class="flex justify-between mt-1"><span class="text-[10px] text-slate-400">${r.hn||''}</span></div><div class="text-xs text-slate-600 truncate mt-1">${r.name}</div></div>`; 
                }); 
                html += `</div></div>`; 
                container.innerHTML += html; 
            }); 
        }

        function renderHandoff() {
            const container = document.getElementById('handoffContent');
            const activeRecords = records.filter(r => r.ward === currentWard && !r.is_discharged).sort((a,b) => parseInt(a.bed_number) - parseInt(b.bed_number));
            if(activeRecords.length === 0) { container.innerHTML = "No patients."; return; }

            let html = `
            <div class="mb-4 pb-4 border-b border-slate-300 flex justify-between">
                <div><h1 class="text-xl font-bold">Internal Medicine Sign-Out</h1><p>Ward: ${currentWard} | Date: ${new Date().toLocaleDateString()}</p></div>
                <div class="text-right"><p>Total: ${activeRecords.length}</p></div>
            </div>
            <table class="w-full text-left border-collapse">
                <thead><tr class="border-b-2 border-slate-300 text-slate-600 uppercase text-[10px]"><th class="py-2 w-12">Bed</th><th class="py-2 w-32">Patient</th><th class="py-2">Active Issues / Plan</th><th class="py-2 w-32">To-Do</th></tr></thead>
                <tbody>`;
            
            activeRecords.forEach(r => {
                const todos = r.todo_list.filter(t => !t.done).map(t => `• ${t.text}`).join('<br>');
                html += `
                <tr class="border-b border-slate-100 py-2 align-top">
                    <td class="py-3 font-bold text-lg">${r.bed_number}</td>
                    <td class="py-3"><div class="font-bold">${r.name}</div><div class="text-slate-500">${r.hn}</div></td>
                    <td class="py-3 whitespace-pre-wrap leading-relaxed text-slate-700">${r.details || '-'}</td>
                    <td class="py-3 text-rose-600 font-bold">${todos}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function printHandoff() { 
            document.getElementById('printContainer').innerHTML = document.getElementById('handoffContent').innerHTML;
            window.print(); 
        }

        function renderDischarged() {
            const list = document.getElementById('dischargedList'); list.innerHTML = "";
            const archived = records.filter(r => r.is_discharged);
            if (archived.length === 0) { list.innerHTML = "<div class='col-span-full text-center p-10 text-slate-400 italic'>No archived records found.</div>"; return; }
            archived.forEach(r => {
                const dateStr = r.updated_at ? new Date(r.updated_at).toLocaleDateString() : 'N/A';
                const isSelected = selectedIds.has(r.id);
                const selClass = isSelected ? 'ring-2 ring-medical-500 border-medical-500 bg-medical-50' : 'border-slate-200 hover:border-medical-400';
                list.innerHTML += `
                <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center cursor-pointer transition ${selClass}" onclick="handleItemClick('${r.id}', null)">
                    <div>
                        <h4 class="font-bold text-slate-800">${r.name}</h4>
                        <p class="text-xs text-slate-500">HN: ${r.hn} • Ward: ${r.ward}</p>
                        <p class="text-[10px] text-slate-400 mt-1">Archived: ${dateStr}</p>
                    </div>
                    <button onclick="restorePatient('${r.id}', event)" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-bold hover:bg-emerald-200 transition">Restore</button>
                </div>`;
            });
        }

        function toggleSelectMode() { 
            isSelectMode = !isSelectMode; if(!isSelectMode) selectedIds.clear(); 
            document.getElementById('selectionToolbar').classList.toggle('hidden', !isSelectMode); 
            document.getElementById('btnSelectMode').classList.toggle('text-medical-600', isSelectMode); 
            renderView(); 
        }
        function handleItemClick(id, bedNum) { if (isSelectMode) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); document.getElementById('selectCount').innerText = selectedIds.size; renderView(); } else { openEditor(id, bedNum); } }

        async function deleteBatch() { 
            if(!confirm(`Delete ${selectedIds.size} items?`)) return; 
            clearInterval(refreshTimer); clearInterval(autoSaveTimer);
            const batches = {}; const localDeleteIds = new Set();
            selectedIds.forEach(id => { const r = records.find(x => x.id === id); if (r) { const target = (ROLE === 'chief' && r.owner) ? r.owner : DB_NAME; if (!batches[target]) batches[target] = []; batches[target].push(id); localDeleteIds.add(id); }});
            records = records.filter(r => !localDeleteIds.has(r.id)); renderView(); toggleSelectMode();
            const requests = Object.entries(batches).map(([targetDb, ids]) => fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', db: targetDb, requester: DB_NAME, password: PASSWORD, ids: ids}) }));
            try { await Promise.all(requests); showToast("Batch delete complete", true); } catch(e) { alert("Some items failed."); } finally { startAutomation(); }
        }

        function exportBatch() {
            const items = records.filter(r => selectedIds.has(r.id));
            items.forEach(r => {
                const fn = `${r.name||'Patient'}_HN${r.hn||'None'}.txt`;
                let txt = `Name: ${r.name}\nHN: ${r.hn}\nBed: ${r.bed_number}\nWard: ${r.ward}\n\nDETAILS:\n${r.details||'-'}\n\n`;
                if(r.todo_list.length) txt += `TODO:\n${r.todo_list.map(t => (t.done?'[x] ':'[ ] ')+t.text).join('\n')}`;
                const a = document.createElement("a"); a.href = window.URL.createObjectURL(new Blob([txt], {type: "text/plain"})); a.download = fn; a.click();
            });
            toggleSelectMode();
        }

        function openEditor(id, bedNum) {
            toggleElement('editorModal', true); editingId = id; currentTodos = []; activeConsults = []; currentDischarged = false; originalOwner = null;
            const sel = document.getElementById('editBed'); sel.innerHTML = ""; for(let i=1; i<=100; i++) sel.innerHTML += `<option value="${i}">${i}</option>`;
            if (id) {
                const r = records.find(x => x.id === id); originalOwner = r.owner;
                if(ROLE === 'chief') { 
                    const resSel = document.getElementById('residentSelect'); document.getElementById('residentSelectorDiv').classList.remove('hidden'); 
                    let opts = availableResidents.map(r => `<option value="${r}">${r}</option>`);
                    if (originalOwner && !availableResidents.includes(originalOwner)) opts.unshift(`<option value="${originalOwner}">${originalOwner} (Current)</option>`);
                    resSel.innerHTML = opts.join(''); resSel.value = originalOwner;
                }
                document.getElementById('editorTitle').innerText = "Edit Patient"; document.getElementById('editBed').value = r.bed_number; document.getElementById('editorBedBadge').innerText = `#${r.bed_number}`;
                document.getElementById('editHN').value = r.hn; document.getElementById('editName').value = r.name; setDetails(r.details);
                activeConsults = r.consult_units ? JSON.parse(JSON.stringify(r.consult_units)) : []; currentTodos = r.todo_list ? JSON.parse(JSON.stringify(r.todo_list)) : [];
                currentDischarged = !!r.is_discharged; setActiveColor(r.color_id); toggleElement('btnDelete', true);
            } else {
                if(ROLE === 'chief') { 
                    const resSel = document.getElementById('residentSelect'); document.getElementById('residentSelectorDiv').classList.remove('hidden'); 
                    // Populate from available, default to currently selected if possible
                    resSel.innerHTML = availableResidents.map(r => `<option value="${r}" ${r===chiefSelectedDB?'selected':''}>${r}</option>`).join('');
                    originalOwner = resSel.value;
                }
                document.getElementById('editorTitle').innerText = "Admit Patient"; document.getElementById('editBed').value = bedNum || 1; document.getElementById('editorBedBadge').innerText = `#${bedNum||1}`;
                document.getElementById('editHN').value = ""; document.getElementById('editName').value = ""; setDetails(""); setActiveColor('#ffffff'); toggleElement('btnDelete', false);
                currentTodos = [{text: "", done: false}, {text: "", done: false}];
            }
            renderConsults(); renderTodos(); updateDischargeBtn();
        }

        function closeEditor() { toggleElement('editorModal', false); editingId = null; }
        function changeBedInEditor() { document.getElementById('editorBedBadge').innerText='#'+document.getElementById('editBed').value; saveRecord(true); }
        function setDetails(text) { document.getElementById('editDetailsDesktop').value = text || ""; document.getElementById('editDetailsMobile').value = text || ""; document.getElementById('fullscreenEditor').value = text || ""; }
        function syncDetails(el) { const val = el.value; if(el.id !== 'editDetailsDesktop') document.getElementById('editDetailsDesktop').value = val; if(el.id !== 'editDetailsMobile') document.getElementById('editDetailsMobile').value = val; if(el.id !== 'fullscreenEditor') document.getElementById('fullscreenEditor').value = val; }
        function renderConsults() { const div = document.getElementById('consultContainer'); div.innerHTML = ""; const allUnits = [...STANDARD_UNITS]; activeConsults.forEach(ac => { if (!allUnits.find(u => u.id === ac.id)) allUnits.push(ac); }); allUnits.forEach(u => { const isActive = activeConsults.find(ac => ac.id === u.id); div.innerHTML += `<div onclick="toggleConsult('${u.id}', '${u.icon}')" class="consult-chip ${isActive?'active':'inactive'}"><i class="fa-solid ${u.icon}"></i> ${u.id}</div>`; }); }
        function toggleConsult(id, icon) { const idx = activeConsults.findIndex(c => c.id === id); if(idx > -1) activeConsults.splice(idx, 1); else activeConsults.push({id, icon}); renderConsults(); }
        function addCustomConsult() { const val = document.getElementById('customConsult').value.trim(); if(val) { activeConsults.push({id: val, icon: 'fa-user-md'}); document.getElementById('customConsult').value = ""; renderConsults(); } }
        function renderTodos() { const div = document.getElementById('todoContainer'); div.innerHTML = ""; currentTodos.forEach((t, i) => { div.innerHTML += `<div class="flex items-center gap-2 p-2 bg-white rounded border ${t.done ? 'border-green-200 bg-green-50' : 'border-slate-200'}"><input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo(${i})" class="accent-green-500"><input type="text" value="${t.text}" placeholder="Add task..." list="taskSuggestions" onblur="currentTodos[${i}].text=this.value" id="todoInput-${i}" class="flex-1 bg-transparent outline-none text-xs ${t.done ? 'line-through text-green-600' : 'text-slate-700'}"><i class="fa-solid fa-xmark text-slate-300 cursor-pointer" onclick="removeTodo(${i})"></i></div>`; }); }
        function addTodo() { currentTodos.push({text:"", done:false}); renderTodos(); setTimeout(() => { document.getElementById(`todoInput-${currentTodos.length-1}`).focus(); }, 50); }
        function removeTodo(i) { currentTodos.splice(i,1); renderTodos(); }
        function toggleTodo(i) { currentTodos[i].done = !currentTodos[i].done; renderTodos(); }
        function renderColorPicker() { document.getElementById('colorContainer').innerHTML = COLORS.map(c => `<div class="color-dot bg-[${c}] shadow-sm" style="background-color: ${c}" onclick="setActiveColor('${c}')" data-col="${c}"></div>`).join(''); }
        function setActiveColor(c) { document.querySelectorAll('.color-dot').forEach(el => el.classList.toggle('selected', el.dataset.col === c)); document.getElementById('colorContainer').dataset.selected = c; }
        
        // --- CORE ACTIONS ---
        function changeWard() {
            toggleElement('wardModal', true);
            document.getElementById('wardList').innerHTML = Array.from(wards).map(w => `
                <div class="flex items-center gap-2 mb-2">
                    <div onclick="selectWard('${w}')" class="flex-1 p-3 rounded-lg cursor-pointer font-bold transition flex justify-between ${w === currentWard ? 'bg-medical-50 text-medical-700 border border-medical-200' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}">
                        ${w} ${w===currentWard ? '<i class="fa-solid fa-check"></i>':''}
                    </div>
                    ${w !== 'General Ward' ? `<button onclick="deleteWard('${w}')" class="w-10 h-10 rounded-lg bg-rose-50 text-rose-400 hover:bg-rose-100 hover:text-rose-600 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>` : ''}
                </div>
            `).join('');
        }
        function createNewWard() { const n = document.getElementById('newWardName').value.trim(); if(n) { currentWard = n; wards.add(n); changeWard(); renderView(); }}
        function selectWard(n) { currentWard = n; toggleElement('wardModal', false); renderView(); }
        
        function showToast(msg, isSuccess = false) {
            const toast = document.getElementById('saveToast'); const toastMsg = document.getElementById('saveToastMsg'); clearTimeout(toastTimer);
            toastMsg.innerText = msg; toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 z-[10001] px-6 py-3 rounded-full text-white font-bold shadow-2xl transition-all duration-300 flex items-center gap-3 translate-y-0 opacity-100 pointer-events-none ${isSuccess ? 'bg-emerald-600' : 'bg-slate-900'}`;
            if (isSuccess) toastTimer = setTimeout(() => { const bgClass = toast.classList.contains('bg-emerald-600') ? 'bg-emerald-600' : 'bg-slate-900'; toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 z-[10001] px-6 py-3 rounded-full text-white font-bold shadow-2xl transition-all duration-300 flex items-center gap-3 translate-y-10 opacity-0 pointer-events-none ${bgClass}`; }, 2000);
        }

        async function saveRecord(silent = false) {
            const btn = document.getElementById('btnSave'); 
            if(!silent) { btn.innerText = "Saving..."; showToast("Saving..."); }
            
            const targetBed = document.getElementById('editBed').value; 
            const targetName = document.getElementById('editName').value.trim();
            const detailsVal = document.getElementById('editDetailsDesktop').value.trim();
            const validTodos = currentTodos.filter(t => t.text.trim() !== "");
            
            if (silent && !editingId && !targetName && !detailsVal && activeConsults.length === 0 && validTodos.length === 0) return;
            
            const conflict = records.find(r => r.id !== editingId && r.ward === currentWard && !r.is_discharged && (r.bed_number == targetBed || (targetName && r.name === targetName)));
            if (conflict && !silent) { if(!confirm(`CONFLICT DETECTED!\nBed ${conflict.bed_number} occupied by ${conflict.name}.\nOverwrite?`)) { btn.innerHTML = `<i class="fa-solid fa-floppy-disk"></i> Save Changes`; return; } }
            
            let name = targetName; if(!name) { const count = records.length + 1; name = `Patient_${String(count).padStart(3, '0')}`; }
            
            // Current State from Editor
            const currentRecord = records.find(r => r.id === editingId);
            const clientLastUpdated = currentRecord ? currentRecord.updated_at : null;

            const p = { 
                id: editingId || 'rec_' + Date.now(), 
                bed_number: targetBed, hn: document.getElementById('editHN').value, name: name, ward: currentWard, 
                details: detailsVal, consult_units: JSON.stringify(activeConsults), 
                color_id: document.getElementById('colorContainer').dataset.selected || '#ffffff', 
                todo_list: JSON.stringify(validTodos), is_discharged: currentDischarged,
                last_updated_client: clientLastUpdated // Protocol C: Send timestamp
            };

            let targetDB = DB_NAME;
            if (ROLE === 'chief') { 
                // Ensure we save to the currently selected Chief View DB or the Resident selector in modal
                targetDB = document.getElementById('residentSelect').value || chiefSelectedDB; 
                if(!targetDB) { alert("Please select a resident."); return; } 
            }
            
            const payload = { action: 'save', db: targetDB, requester: DB_NAME, password: PASSWORD, ...p };
            
            if (ROLE !== 'chief') { 
                const clean = {...p, consult_units: activeConsults, todo_list: validTodos}; 
                const idx = records.findIndex(r => r.id === p.id); 
                if(idx > -1) records[idx] = clean; else records.push(clean); 
                if(!silent) renderView(); editingId = p.id; 
            }
            if(!silent && !document.getElementById('fullscreenOverlay').classList.contains('hidden')) {} else if (!silent) { closeEditor(); }
            
            const res = await fetch(API_URL, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify(payload) });
            const json = await res.json();

            // --- PROTOCOL C: HANDLING CONFLICTS ---
            if (json.status === 'conflict') {
                if(confirm(`DATA CONFLICT!\n\nThe server has newer data for this patient.\nYour changes: ${p.details.substring(0,20)}...\nServer data: ${json.serverData.details.substring(0,20)}...\n\nClick OK to OVERWRITE server (force save).\nClick Cancel to DISCARD your changes and reload.`)) {
                     // Force Save
                     payload.force = true;
                     await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                     showToast("Forced Update Success", true);
                } else {
                    // Discard and Reload
                    fetchData();
                    alert("Reloaded latest data.");
                }
            } else if (json.status === 'success') {
                if (ROLE === 'chief') fetchData(true);
                else {
                     const idx = records.findIndex(r => r.id === p.id); 
                     if(idx > -1) records[idx].updated_at = json.updated_at;
                }
                if(!silent) { btn.innerHTML = `<i class="fa-solid fa-floppy-disk"></i> Save Changes`; showToast("Saved Successfully", true); }
            }
        }
        
        async function deleteRecord() { 
            if(!confirm("Permanently delete?")) return; 
            clearInterval(autoSaveTimer);
            records = records.filter(r => r.id !== editingId); 
            const targetDB = (ROLE === 'chief' && originalOwner) ? originalOwner : DB_NAME; const idToDelete = editingId;
            renderView(); closeEditor(); 
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', db: targetDB, requester: DB_NAME, password: PASSWORD, id: idToDelete}) });
            startAutomation();
        }

        function manualRefresh() { fetchData(); }
        function toggleElement(id, show) { const el = document.getElementById(id); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function updateDischargeBtn() { const btn = document.getElementById('btnDischarge'); btn.innerText = currentDischarged ? "Discharged" : "Archive"; btn.className = currentDischarged ? "px-4 py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold transition" : "px-4 py-2 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold transition hover:bg-slate-200"; }
        function toggleDischarge() { currentDischarged = !currentDischarged; updateDischargeBtn(); }
        function toggleFullScreen() { const fsEl = document.getElementById('fullscreenOverlay'); fsEl.classList.toggle('hidden'); if(!fsEl.classList.contains('hidden')) { const editor = document.getElementById('fullscreenEditor'); editor.focus(); } }
        
        async function restorePatient(id, event) {
            event.stopPropagation();
            const r = records.find(x => x.id === id);
            const newBed = prompt(`Restore ${r.name} to Bed Number:`, r.bed_number || 1);
            if (!newBed) return;
            r.is_discharged = false; r.bed_number = newBed; r.updated_at = new Date().toISOString();
            const p = { id: r.id, is_discharged: false, ward: r.ward, bed_number: newBed, hn: r.hn, name: r.name, details: r.details, consult_units: JSON.stringify(r.consult_units), color_id: r.color_id, todo_list: JSON.stringify(r.todo_list) };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'save', db: r.owner || DB_NAME, password: PASSWORD, requester: DB_NAME, ...p}) });
            renderView();
        }
        async function deleteWard(wardName) {
            const pwd = prompt(`WARNING: Deleting ward "${wardName}" will erase ALL associated patient records.\nEnter your password to confirm:`);
            if (!pwd) return;
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'auth_verify', db: DB_NAME, password: pwd}) });
            const json = await res.json();
            if (json.status === 'success') {
                const toDelete = records.filter(r => r.ward === wardName).map(r => r.id);
                records = records.filter(r => r.ward !== wardName);
                wards.delete(wardName); if (currentWard === wardName) currentWard = "General Ward"; changeWard();
                if(toDelete.length > 0) { await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', db: DB_NAME, password: pwd, ids: toDelete}) }); }
            } else { alert("Incorrect Password"); }
        }
        document.getElementById('fullscreenEditor').addEventListener('input', function() { syncDetails(this); });
    </script>
</body>
</html>
